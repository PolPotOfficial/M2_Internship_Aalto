{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "cfd00ada",
   "metadata": {},
   "outputs": [],
   "source": [
    "import geopandas as gpd\n",
    "import pandas as pd\n",
    "import osmnx as ox"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "a762077c",
   "metadata": {},
   "outputs": [],
   "source": [
    "path1 = \"/users/eleves-b/2023/wenrui.dai/Desktop/environment/Helsinki/TD_415M.gpkg\"\n",
    "path2 = \"/users/eleves-b/2023/wenrui.dai/Desktop/environment/Helsinki/TD_415N.gpkg\"\n",
    "m15 = gpd.read_file(path1)\n",
    "n15 = gpd.read_file(path2)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "7f7c2fde",
   "metadata": {},
   "outputs": [],
   "source": [
    "m_modes = {c.split(\"total_emission_\")[1] for c in m15.columns if c.startswith(\"total_emission_\")}\n",
    "n_modes = {c.split(\"total_emission_\")[1] for c in n15.columns if c.startswith(\"total_emission_\")}\n",
    "modes = sorted(m_modes & n_modes)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "5b792ad9",
   "metadata": {},
   "outputs": [],
   "source": [
    "m15 = m15.rename(columns={\n",
    "    \"total_emission\": \"total_emission_m\",\n",
    "    **{f\"total_emission_{mode}\": f\"total_emission_{mode}_m\" for mode in m_modes}\n",
    "})\n",
    "n15 = n15.rename(columns={\n",
    "    \"total_emission\": \"total_emission_n\",\n",
    "    **{f\"total_emission_{mode}\": f\"total_emission_{mode}_n\" for mode in n_modes}\n",
    "})"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "734bee04",
   "metadata": {},
   "outputs": [],
   "source": [
    "m_cols_to_scale = [\"total_emission_m\"] + [f\"total_emission_{mode}_m\" for mode in m_modes]\n",
    "n_cols_to_scale = [\"total_emission_n\"] + [f\"total_emission_{mode}_n\" for mode in n_modes]\n",
    "\n",
    "for cols, df in [(m_cols_to_scale, m15), (n_cols_to_scale, n15)]:\n",
    "    existing = [c for c in cols if c in df.columns]\n",
    "    if existing:\n",
    "        df[existing] = df[existing].apply(pd.to_numeric, errors=\"coerce\").div(1000.0)\n",
    "\n",
    "keep_n = [\"from_id\", \"total_emission_n\"] + [f\"total_emission_{mode}_n\" for mode in modes]\n",
    "merged = m15.merge(n15[keep_n], on=\"from_id\", how=\"inner\")\n",
    "\n",
    "merged[\"emission_diff\"] = merged[\"total_emission_m\"].fillna(0) - merged[\"total_emission_n\"].fillna(0)\n",
    "\n",
    "for mode in modes:\n",
    "    merged[f\"emission_diff_{mode}\"] = (\n",
    "        merged[f\"total_emission_{mode}_m\"].fillna(0) - merged[f\"total_emission_{mode}_n\"].fillna(0)\n",
    "    )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "e4c5b8b9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>from_id</th>\n",
       "      <th>total_emission_m</th>\n",
       "      <th>total_emission_bus_m</th>\n",
       "      <th>total_emission_rail_m</th>\n",
       "      <th>total_emission_subway_m</th>\n",
       "      <th>total_emission_tram_m</th>\n",
       "      <th>total_emission_walk_m</th>\n",
       "      <th>total_emission_ferry_m</th>\n",
       "      <th>geometry</th>\n",
       "      <th>total_emission_n</th>\n",
       "      <th>...</th>\n",
       "      <th>total_emission_subway_n</th>\n",
       "      <th>total_emission_tram_n</th>\n",
       "      <th>total_emission_walk_n</th>\n",
       "      <th>emission_diff</th>\n",
       "      <th>emission_diff_bus</th>\n",
       "      <th>emission_diff_ferry</th>\n",
       "      <th>emission_diff_rail</th>\n",
       "      <th>emission_diff_subway</th>\n",
       "      <th>emission_diff_tram</th>\n",
       "      <th>emission_diff_walk</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>890899610dbffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.5931 60.24495, 24.59578 60.24427,...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>89089961323ffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.6503 60.26155, 24.65298 60.26086,...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>89089961357ffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.64148 60.25069, 24.64416 60.25001...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>8908996145bffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.57039 60.24088, 24.57308 60.2402,...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>89089961643ffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.5931 60.22696, 24.59578 60.22628,...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1483</th>\n",
       "      <td>891126d76cbffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.99428 60.27069, 24.99697 60.27, 2...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1484</th>\n",
       "      <td>891126d76d3ffff</td>\n",
       "      <td>132.492888</td>\n",
       "      <td>97.106688</td>\n",
       "      <td>0.0</td>\n",
       "      <td>35.386200</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.98621 60.27275, 24.9889 60.27207,...</td>\n",
       "      <td>122.850626</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>9.642262</td>\n",
       "      <td>2.500762</td>\n",
       "      <td>0.0</td>\n",
       "      <td>-28.2447</td>\n",
       "      <td>35.3862</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1485</th>\n",
       "      <td>891126d76d7ffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((24.98845 60.27547, 24.99114 60.27478...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1486</th>\n",
       "      <td>891126dad8fffff</td>\n",
       "      <td>69.353882</td>\n",
       "      <td>52.480570</td>\n",
       "      <td>0.0</td>\n",
       "      <td>16.873313</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((25.06342 60.15917, 25.06611 60.15847...</td>\n",
       "      <td>62.652007</td>\n",
       "      <td>...</td>\n",
       "      <td>16.873313</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>6.701875</td>\n",
       "      <td>6.701875</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1487</th>\n",
       "      <td>891126dadbbffff</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>POLYGON ((25.06566 60.16188, 25.06835 60.16119...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>...</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1488 rows Ã— 23 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "              from_id  total_emission_m  total_emission_bus_m  \\\n",
       "0     890899610dbffff          0.000000              0.000000   \n",
       "1     89089961323ffff          0.000000              0.000000   \n",
       "2     89089961357ffff          0.000000              0.000000   \n",
       "3     8908996145bffff          0.000000              0.000000   \n",
       "4     89089961643ffff          0.000000              0.000000   \n",
       "...               ...               ...                   ...   \n",
       "1483  891126d76cbffff          0.000000              0.000000   \n",
       "1484  891126d76d3ffff        132.492888             97.106688   \n",
       "1485  891126d76d7ffff          0.000000              0.000000   \n",
       "1486  891126dad8fffff         69.353882             52.480570   \n",
       "1487  891126dadbbffff          0.000000              0.000000   \n",
       "\n",
       "      total_emission_rail_m  total_emission_subway_m  total_emission_tram_m  \\\n",
       "0                       0.0                 0.000000                    0.0   \n",
       "1                       0.0                 0.000000                    0.0   \n",
       "2                       0.0                 0.000000                    0.0   \n",
       "3                       0.0                 0.000000                    0.0   \n",
       "4                       0.0                 0.000000                    0.0   \n",
       "...                     ...                      ...                    ...   \n",
       "1483                    0.0                 0.000000                    0.0   \n",
       "1484                    0.0                35.386200                    0.0   \n",
       "1485                    0.0                 0.000000                    0.0   \n",
       "1486                    0.0                16.873313                    0.0   \n",
       "1487                    0.0                 0.000000                    0.0   \n",
       "\n",
       "      total_emission_walk_m  total_emission_ferry_m  \\\n",
       "0                       0.0                     0.0   \n",
       "1                       0.0                     0.0   \n",
       "2                       0.0                     0.0   \n",
       "3                       0.0                     0.0   \n",
       "4                       0.0                     0.0   \n",
       "...                     ...                     ...   \n",
       "1483                    0.0                     0.0   \n",
       "1484                    0.0                     0.0   \n",
       "1485                    0.0                     0.0   \n",
       "1486                    0.0                     0.0   \n",
       "1487                    0.0                     0.0   \n",
       "\n",
       "                                               geometry  total_emission_n  \\\n",
       "0     POLYGON ((24.5931 60.24495, 24.59578 60.24427,...          0.000000   \n",
       "1     POLYGON ((24.6503 60.26155, 24.65298 60.26086,...          0.000000   \n",
       "2     POLYGON ((24.64148 60.25069, 24.64416 60.25001...          0.000000   \n",
       "3     POLYGON ((24.57039 60.24088, 24.57308 60.2402,...          0.000000   \n",
       "4     POLYGON ((24.5931 60.22696, 24.59578 60.22628,...          0.000000   \n",
       "...                                                 ...               ...   \n",
       "1483  POLYGON ((24.99428 60.27069, 24.99697 60.27, 2...          0.000000   \n",
       "1484  POLYGON ((24.98621 60.27275, 24.9889 60.27207,...        122.850626   \n",
       "1485  POLYGON ((24.98845 60.27547, 24.99114 60.27478...          0.000000   \n",
       "1486  POLYGON ((25.06342 60.15917, 25.06611 60.15847...         62.652007   \n",
       "1487  POLYGON ((25.06566 60.16188, 25.06835 60.16119...          0.000000   \n",
       "\n",
       "      ...  total_emission_subway_n  total_emission_tram_n  \\\n",
       "0     ...                 0.000000                    0.0   \n",
       "1     ...                 0.000000                    0.0   \n",
       "2     ...                 0.000000                    0.0   \n",
       "3     ...                 0.000000                    0.0   \n",
       "4     ...                 0.000000                    0.0   \n",
       "...   ...                      ...                    ...   \n",
       "1483  ...                 0.000000                    0.0   \n",
       "1484  ...                 0.000000                    0.0   \n",
       "1485  ...                 0.000000                    0.0   \n",
       "1486  ...                16.873313                    0.0   \n",
       "1487  ...                 0.000000                    0.0   \n",
       "\n",
       "      total_emission_walk_n  emission_diff  emission_diff_bus  \\\n",
       "0                       0.0       0.000000           0.000000   \n",
       "1                       0.0       0.000000           0.000000   \n",
       "2                       0.0       0.000000           0.000000   \n",
       "3                       0.0       0.000000           0.000000   \n",
       "4                       0.0       0.000000           0.000000   \n",
       "...                     ...            ...                ...   \n",
       "1483                    0.0       0.000000           0.000000   \n",
       "1484                    0.0       9.642262           2.500762   \n",
       "1485                    0.0       0.000000           0.000000   \n",
       "1486                    0.0       6.701875           6.701875   \n",
       "1487                    0.0       0.000000           0.000000   \n",
       "\n",
       "      emission_diff_ferry  emission_diff_rail  emission_diff_subway  \\\n",
       "0                     0.0              0.0000                0.0000   \n",
       "1                     0.0              0.0000                0.0000   \n",
       "2                     0.0              0.0000                0.0000   \n",
       "3                     0.0              0.0000                0.0000   \n",
       "4                     0.0              0.0000                0.0000   \n",
       "...                   ...                 ...                   ...   \n",
       "1483                  0.0              0.0000                0.0000   \n",
       "1484                  0.0            -28.2447               35.3862   \n",
       "1485                  0.0              0.0000                0.0000   \n",
       "1486                  0.0              0.0000                0.0000   \n",
       "1487                  0.0              0.0000                0.0000   \n",
       "\n",
       "      emission_diff_tram  emission_diff_walk  \n",
       "0                    0.0                 0.0  \n",
       "1                    0.0                 0.0  \n",
       "2                    0.0                 0.0  \n",
       "3                    0.0                 0.0  \n",
       "4                    0.0                 0.0  \n",
       "...                  ...                 ...  \n",
       "1483                 0.0                 0.0  \n",
       "1484                 0.0                 0.0  \n",
       "1485                 0.0                 0.0  \n",
       "1486                 0.0                 0.0  \n",
       "1487                 0.0                 0.0  \n",
       "\n",
       "[1488 rows x 23 columns]"
      ]
     },
     "execution_count": 28,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "merged"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "fdf90e7d",
   "metadata": {},
   "outputs": [],
   "source": [
    "output_path = \"/users/eleves-b/2023/wenrui.dai/Desktop/environment/Helsinki/TD_415_diff.gpkg\"\n",
    "merged.to_file(output_path, driver=\"GPKG\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "sustainability-gis",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
